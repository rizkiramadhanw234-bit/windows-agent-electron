import dotenv from "dotenv";
dotenv.config();

import path from "path";
import { fileURLToPath } from "url";
import express from "express";
import cors from "cors";
import { spawn } from "child_process";
import { createRequire } from "module";
import fs from "fs/promises";
import WebSocket from "ws";

// ==================== IMPORTS ====================
import {
  addPages as storeAddPages,
  getDailyReport,
  debugData,
  cleanupOldData,
} from "./pages/page.store.js";

import {
  getPrinters,
  getPrintersWithInkStatus,
  refreshPrintersWithInkStatus,
  getCacheStatus,
  clearCache,
} from "./printers/printer.service.js";
import { getPrinterErrors } from "./events/eventlog.service.js";
import { monitorAllPrintersInk, getInkStatus } from "./ink/ink.service.js";
import { initializePageCounterService, getConsolidatedDailyReport } from './pages/pagecounter.service.js';

await initializePageCounterService();

setInterval(async () => {
  const report = await getConsolidatedDailyReport();
  console.log('ğŸ“Š Consolidated Report:', JSON.stringify(report, null, 2));
}, 5000);

// ==================== CONFIG ====================
const CONFIG = {
  CLOUD_ENABLED: process.env.CLOUD_ENABLED === "true",
  CLOUD_WS_URL: process.env.CLOUD_WS_URL ||,
  CLOUD_API_KEY: process.env.CLOUD_API_KEY,
  AGENT_ID: process.env.AGENT_ID || "WINDOWS-PC-001",
  AGENT_NAME: process.env.AGENT_NAME || "Windows Office PC",
  COMPANY_NAME: process.env.COMPANY_NAME || "PT. Kudukuats",
  AGENT_LOCATION: process.env.AGENT_LOCATION || "Jakarta Office",
  HTTP_PORT: process.env.HTTP_PORT || 5001,
  INK_CHECK_INTERVAL: parseInt(process.env.INK_CHECK_INTERVAL) || 30000,
};

const require = createRequire(import.meta.url);
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==================== GLOBAL VARIABLES ====================
let cloudWs = null;
let isCloudConnected = false;
const powerShellProcesses = {
  pageCounter: null,
  printerMonitor: null,
  printerWatcher: null,
};

// ==================== HTTP SERVER ====================
const app = express();
app.use(cors());
app.use(express.json());

const HTTP_PORT = CONFIG.HTTP_PORT;

// ==================== CLOUD CONNECTION ====================
function connectToCloud() {
  if (!CONFIG.CLOUD_ENABLED) {
    console.log("âš ï¸ Cloud connection disabled");
    return;
  }

  try {
    console.log(`ğŸ”— Connecting to backend: ${CONFIG.CLOUD_WS_URL}`);

    cloudWs = new WebSocket(CONFIG.CLOUD_WS_URL, {
      headers: {
        Authorization: `Bearer ${CONFIG.CLOUD_API_KEY}`,
      },
    });

    cloudWs.on("open", () => {
      console.log("âœ… Connected to Backend Server");
      isCloudConnected = true;

      // Register agent
      cloudWs.send(
        JSON.stringify({
          type: "device_register",
          agentId: CONFIG.AGENT_ID,
          data: {
            agentId: CONFIG.AGENT_ID,
            agentName: CONFIG.AGENT_NAME,
            hostname: require("os").hostname(),
            platform: process.platform,
            arch: process.arch,
            company: CONFIG.COMPANY_NAME,
            location: CONFIG.AGENT_LOCATION,
          },
        }),
      );
    });

    cloudWs.on("message", (data) => {
      try {
        const message = JSON.parse(data.toString());
        console.log(`ğŸ“¨ Received message from backend: ${message.type}`);

        if (message.type === "registration_ack") {
          console.log("âœ… Registration acknowledged:", message.message);
          sendInitialData();
        }

        if (message.type === "command") {
          handleCommand(message);
        }
      } catch (error) {
        console.error("Error parsing backend message:", error);
      }
    });

    cloudWs.on("close", () => {
      console.log("ğŸ”Œ Disconnected from backend");
      isCloudConnected = false;
      setTimeout(connectToCloud, 5000);
    });

    cloudWs.on("error", (error) => {
      console.error("WebSocket error:", error.message);
    });
  } catch (error) {
    console.error("Failed to connect to backend:", error);
    setTimeout(connectToCloud, 10000);
  }
}

// ==================== SEND DATA TO BACKEND ====================
async function sendInitialData() {
  try {
    console.log("ğŸ“¤ Sending initial data to backend...");

    // Send printers
    const printers = await getPrinters();
    if (cloudWs && isCloudConnected) {
      cloudWs.send(
        JSON.stringify({
          type: "printer_update",
          data: { printers },
          agentId: CONFIG.AGENT_ID,
        }),
      );
      console.log(`ğŸ“¤ Sent ${printers.length} printers to backend`);
    }

    // Send ink status
    const inkStatus = await monitorAllPrintersInk();
    if (cloudWs && isCloudConnected) {
      cloudWs.send(
        JSON.stringify({
          type: "ink_status",
          data: { inkStatus },
          agentId: CONFIG.AGENT_ID,
        }),
      );
      console.log("ğŸ“¤ Sent ink status to backend");
    }

    // Send daily report
    sendDailyReport();
  } catch (error) {
    console.error("Error sending initial data:", error);
  }
}

async function sendDailyReport() {
  try {
    const response = await fetch(
      `http://localhost:${HTTP_PORT}/api/report/daily`,
    );
    if (response.ok) {
      const dailyReport = await response.json();

      if (cloudWs && isCloudConnected) {
        cloudWs.send(
          JSON.stringify({
            type: "daily_report",
            data: dailyReport,
            agentId: CONFIG.AGENT_ID,
            timestamp: new Date().toISOString(),
          }),
        );

        console.log(
          `ğŸ“¤ Sent daily report to backend: ${dailyReport.totalPages} pages`,
        );
      }
    }
  } catch (error) {
    console.error("Failed to send daily report:", error);
  }
}

// ==================== HANDLE COMMANDS ====================
function handleCommand(message) {
  const { action, printerName, commandId } = message;

  console.log(`âš¡ Command received: ${action} for printer ${printerName}`);

  if (action === "pause_printer") {
    // Implement pause printer logic
    console.log(`â¸ï¸ Pausing printer: ${printerName}`);

    // Send response
    if (cloudWs && isCloudConnected) {
      cloudWs.send(
        JSON.stringify({
          type: "command_response",
          data: {
            commandId,
            success: true,
            message: `Printer ${printerName} paused successfully`,
          },
        }),
      );
    }
  }

  if (action === "resume_printer") {
    // Implement resume printer logic
    console.log(`â–¶ï¸ Resuming printer: ${printerName}`);

    // Send response
    if (cloudWs && isCloudConnected) {
      cloudWs.send(
        JSON.stringify({
          type: "command_response",
          data: {
            commandId,
            success: true,
            message: `Printer ${printerName} resumed successfully`,
          },
        }),
      );
    }
  }
}

// ==================== START MONITORS ====================
async function startAllPrintMonitors() {
  console.log("ğŸ–¨ï¸ Starting ALL print monitors...");

  const scripts = [
    {
      name: "page-counter",
      file: "page-counter.ps1",
      description: "Page Counter",
    },
    {
      name: "printer-monitor",
      file: "printer-monitor.ps1",
      description: "Printer Monitor",
    },
    {
      name: "printer-watcher",
      file: "printer-watcher.ps1",
      description: "Printer Watcher",
    },
  ];

  for (const script of scripts) {
    try {
      await startPowerShellScript(script);
      await new Promise((resolve) => setTimeout(resolve, 1000));
    } catch (error) {
      console.error(`âŒ Failed to start ${script.name}:`, error.message);
    }
  }

  console.log("âœ… All monitors started!");
}

async function startPowerShellScript(script) {
  const scriptPath = path.join(__dirname, "powershell", script.file);

  try {
    await fs.access(scriptPath);
    const stats = await fs.stat(scriptPath);
    console.log(`âœ… Found ${script.file} (${stats.size} bytes)`);
  } catch (error) {
    console.log(`âš ï¸ ${script.file} not found: ${error.message}`);
    return;
  }

  const psProcess = spawn(
    "powershell.exe",
    ["-ExecutionPolicy", "Bypass", "-NoProfile", "-File", scriptPath],
    { stdio: ["pipe", "pipe", "pipe"], windowsHide: true },
  );

  psProcess.stdout.on("data", (data) => {
    const output = data.toString().trim();
    if (output && !output.includes("Windows PowerShell")) {
      console.log(`ğŸ“„ [${script.name}] ${output}`);

      // Detect print events from output
      if (output.includes("printed") && output.includes("pages")) {
        const match = output.match(/(.+) printed (\d+) pages/);
        if (match && cloudWs && isCloudConnected) {
          const [, printerName, pages] = match;
          cloudWs.send(
            JSON.stringify({
              type: "print_event",
              data: {
                printerName: printerName.trim(),
                pages: parseInt(pages),
                timestamp: new Date().toISOString(),
              },
              agentId: CONFIG.AGENT_ID,
            }),
          );
          console.log(
            `ğŸ“¤ Sent print event to backend: ${printerName} - ${pages} pages`,
          );
        }
      }
    }
  });

  psProcess.stderr.on("data", (data) => {
    const error = data.toString().trim();
    if (error && !error.includes("Copyright")) {
      console.error(`âš ï¸ [${script.name} Error] ${error}`);
    }
  });

  psProcess.on("close", (code) => {
    console.log(`ğŸ“ [${script.name}] exited with code ${code}`);
    if (code !== 0) {
      console.log(`ğŸ”„ ${script.name} crashed! Restarting in 10 seconds...`);
      setTimeout(() => startPowerShellScript(script), 10000);
    }
  });

  console.log(`âœ… ${script.description} started`);
  powerShellProcesses[script.name] = psProcess;
}

// ==================== API ENDPOINTS ====================

// Health check
app.get("/api/health", (req, res) => {
  const monitorsStatus = {
    pageCounter: powerShellProcesses.pageCounter ? "RUNNING" : "STOPPED",
    printerMonitor: powerShellProcesses.printerMonitor ? "RUNNING" : "STOPPED",
    printerWatcher: powerShellProcesses.printerWatcher ? "RUNNING" : "STOPPED",
  };

  res.json({
    status: "ok",
    agent: "Windows Printer Agent",
    agentId: CONFIG.AGENT_ID,
    uptime: process.uptime(),
    cloudConnected: isCloudConnected,
    monitors: monitorsStatus,
    timestamp: new Date().toISOString(),
  });
});

// Get all printers
app.get("/api/printers", async (req, res) => {
  try {
    const printers = await getPrinters();
    const printersJson = printers.map((printer) => {
      const printerJson = printer.toJSON ? printer.toJSON() : printer;
      return {
        ...printerJson,
        isOnline: printer.status === "READY" || printer.status === "PRINTING",
        isOffline: printer.status === "OFFLINE" || printer.workOffline,
        isPrinting: printer.status === "PRINTING",
      };
    });

    res.json({
      success: true,
      count: printersJson.length,
      printers: printersJson,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Get printers health
app.get("/api/printers/health", async (req, res) => {
  try {
    const printers = await getPrinters();
    const healthReports = printers.map((printer) => ({
      printer: printer.name,
      status: printer.status || "UNKNOWN",
      rawStatus: printer.rawStatus || 0,
      healthStatus: printer.status === "READY" ? "HEALTHY" : "ERROR",
      inkLevels: printer.inkStatus?.levels || {},
      ipAddress: printer.ipAddress,
      vendor: printer.vendor,
      isOnline: printer.status === "READY",
      lastChecked: new Date().toISOString(),
    }));

    res.json({
      success: true,
      printers: healthReports,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Get ink status
app.get("/api/ink-status", async (req, res) => {
  try {
    const inkStatus = await monitorAllPrintersInk();
    res.json({
      success: true,
      inkStatus: inkStatus,
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Get daily report
app.get("/api/report/daily", async (req, res) => {
  try {
    const report = await getDailyReport();
    res.json(report);
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// Manual print event
app.post("/events/print", async (req, res) => {
  try {
    const { printer, pages } = req.body;
    const result = await storeAddPages(printer, pages);

    // Send to cloud
    if (cloudWs && isCloudConnected) {
      cloudWs.send(
        JSON.stringify({
          type: "print_event",
          data: {
            printerName: printer,
            pages: pages,
            timestamp: new Date().toISOString(),
          },
          agentId: CONFIG.AGENT_ID,
        }),
      );
    }

    res.json({
      success: true,
      message: `Added ${pages} pages to ${printer}`,
      data: result,
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});

// ==================== INITIALIZATION ====================
async function initialize() {
  try {
    await cleanupOldData(30);

    // Startup message
    console.log("\n" + "=".repeat(70));
    console.log("ğŸš€ WINDOWS PRINTER AGENT STARTED");
    console.log("=".repeat(70));
    console.log(`ğŸ†” Agent ID: ${CONFIG.AGENT_ID}`);
    console.log(`ğŸ·ï¸ Agent Name: ${CONFIG.AGENT_NAME}`);
    console.log(`ğŸ¢ Company: ${CONFIG.COMPANY_NAME}`);
    console.log(`ğŸ“ Location: ${CONFIG.AGENT_LOCATION}`);
    console.log(`ğŸŒ Local HTTP API: http://localhost:${HTTP_PORT}`);
    console.log(
      `â˜ï¸ Cloud mode: ${CONFIG.CLOUD_ENABLED ? "ENABLED" : "DISABLED"}`,
    );
    console.log("=".repeat(70));

    // Connect to cloud
    if (CONFIG.CLOUD_ENABLED) {
      connectToCloud();
    }

    // Start monitors
    setTimeout(() => {
      startAllPrintMonitors();
    }, 3000);

    // Periodic tasks
    setInterval(() => {
      if (isCloudConnected) {
        sendDailyReport();
      }
    }, 5000);
  } catch (error) {
    console.error("âŒ Initialization error:", error.message);
  }
}

// Start HTTP server
app.listen(HTTP_PORT, () => {
  console.log(`ğŸŒ Local HTTP API: http://localhost:${HTTP_PORT}`);
});

// Start the agent
initialize();
